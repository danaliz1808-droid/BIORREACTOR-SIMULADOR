<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Biorreactor h√≠brido 3D (Redox Ratio mejorado)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body {
    margin:0; background:#fff; color:#111; font-family:sans-serif;
    display:flex; flex-direction:column; align-items:center;
  }

  #c {
    width:100%;
    height:55vh;   /* vista 3D fija arriba */
    display:block;
    background:#f9f9f9;
  }

  #hud {
    width:90%;
    max-width:400px;
    margin:10px auto;
    padding:10px;
    border-radius:8px;
    background:rgba(255,255,255,0.95);
  }

  #charts {
    width:95%;
    display:flex; flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    margin-bottom:20px;
  }

  .chartCard {
    flex:1 1 300px;
    height:160px;
    background:rgba(255,255,255,0.9);
    border-radius:8px;
    padding:4px;
  }
</style>
</head>
<body>
<canvas id="c"></canvas>

<div id="hud">
  <h3>Biorreactor 3 L ‚Äî Sensor h√≠brido</h3>
  <div>Tiempo: <span id="t">0 h</span></div>
  <div>OD: <span id="od">0</span></div>
  <div>NADH: <span id="nadh">0</span></div>
  <div>FAD: <span id="fad">0</span></div>
  <div>Redox Ratio (Viabilidad): <span id="viab">0</span></div>
  <hr>
  <label>Canal LED</label>
  <select id="channel">
    <option value="NADH">NADH</option>
    <option value="FAD">FAD</option>
    <option value="ALT">Alternar</option>
  </select>
  <label>Potencia LED</label>
  <input id="ledPower" type="range" min="0" max="2" step="0.1" value="1">
  <label>Frecuencia LED (Hz)</label>
  <input id="freq" type="range" min="0" max="5" step="0.1" value="1">
  <button id="pauseBtn">‚è∏ Pausar</button>
</div>

<div id="charts">
  <div class="chartCard"><canvas id="chartOD" class="chart"></canvas></div>
  <div class="chartCard"><canvas id="chartNF" class="chart"></canvas></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
const canvas = document.getElementById('c');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xffffff);

const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/canvas.clientHeight, 0.1, 100);
camera.position.set(7,6,12);
const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.target.set(0,2,0); controls.update();
controls.enableZoom = true;
controls.minDistance = 4;
controls.maxDistance = 20;

scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dir = new THREE.DirectionalLight(0xffffff, 1);
dir.position.set(5,10,7); scene.add(dir);

// LED y sensor
const ledSphere = new THREE.Mesh(new THREE.SphereGeometry(0.2,16,16), new THREE.MeshBasicMaterial({color:0x3aa0ff}));
ledSphere.position.set(-2.5,2.5,0); scene.add(ledSphere);
const ledLight = new THREE.PointLight(0x3aa0ff, 2, 6); ledLight.position.copy(ledSphere.position); scene.add(ledLight);
const sensorBox = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.3,0.3), new THREE.MeshStandardMaterial({color:0x111111}));
sensorBox.position.set(2.5,2.5,0); scene.add(sensorBox);

let model = null;
const loader = new THREE.GLTFLoader();
loader.load(
  "static/Bio_3L.glb",
  function (gltf) {
    model = gltf.scene;
    scene.add(model);
    const box = new THREE.Box3().setFromObject(model);
    const center = box.getCenter(new THREE.Vector3());
    const size = box.getSize(new THREE.Vector3());
    model.position.sub(center);
    const scaleFactor = 5/Math.max(size.x, size.y, size.z);
    model.scale.multiplyScalar(scaleFactor);
    model.position.y += 0.5;
    controls.target.copy(center);
    controls.update();
  },
  undefined,
  function (error) { console.error("‚ùå Error cargando GLB:", error); }
);

// Variables
let tSim=0, X=0.1, NADH=0.1, FAD=0.1, paused=false;
let ui={channel:'NADH', ledPower:1, freq:1};

// Gr√°ficas
let chartOD = new Chart(document.getElementById('chartOD'), {
  type:'line', data:{labels:[],datasets:[{label:'OD',data:[],borderColor:'blue',borderWidth:2,pointRadius:0}]},
  options:{responsive:true,maintainAspectRatio:false,animation:false}
});
let chartNF = new Chart(document.getElementById('chartNF'), {
  type:'line', data:{labels:[],datasets:[
    {label:'NADH',data:[],borderColor:'blue',borderWidth:2,pointRadius:0},
    {label:'FAD',data:[],borderColor:'orange',borderWidth:2,pointRadius:0},
    {label:'Redox Ratio (FAD/(NADH+FAD))',data:[],borderColor:'green',borderDash:[5,5],borderWidth:2,pointRadius:0}
  ]}, options:{responsive:true,maintainAspectRatio:false,animation:false}
});

// üîπ Din√°mica ajustada
function step(dt){
  tSim += dt;

  // Biomasa (crecimiento log√≠stico)
  X += 0.01 * X * (1 - X/10) * dt;
  let OD = 1.2 * X / (1 + 0.3 * X);

  // Se√±ales redox m√°s diferenciadas
  let nadh_frac = (1 - Math.exp(-0.3 * tSim));  // crece con el tiempo
  let fad_frac  = Math.exp(-0.3 * tSim);        // decae con el tiempo

  NADH = 0.8 * nadh_frac * OD;   // sube
  FAD  = 0.8 * fad_frac;         // baja
  let ORR = FAD / (NADH + FAD + 1e-6);

  // Mostrar en HUD
  document.getElementById('t').textContent = tSim.toFixed(2)+' h';
  document.getElementById('od').textContent = OD.toFixed(3);
  document.getElementById('nadh').textContent = NADH.toFixed(3);
  document.getElementById('fad').textContent = FAD.toFixed(3);
  document.getElementById('viab').textContent = ORR.toFixed(3);

  // Actualizar gr√°ficas
  if(chartOD.data.labels.length > 200){
    chartOD.data.labels.shift();
    chartOD.data.datasets[0].data.shift();
  }
  chartOD.data.labels.push(tSim.toFixed(1));
  chartOD.data.datasets[0].data.push(OD);
  chartOD.update('none');

  if(chartNF.data.labels.length > 200){
    chartNF.data.labels.shift();
    chartNF.data.datasets.forEach(d=>d.data.shift());
  }
  chartNF.data.labels.push(tSim.toFixed(1));
  chartNF.data.datasets[0].data.push(NADH);
  chartNF.data.datasets[1].data.push(FAD);
  chartNF.data.datasets[2].data.push(ORR);
  chartNF.update('none');
}

// Animaci√≥n
let last=performance.now();
function animate(now){
  requestAnimationFrame(animate);
  let dt=(now-last)/1000; last=now;
  if(!paused){ step(dt*0.1); }
  if(model){ model.rotation.y += 0.001; }
  ledLight.intensity = 3*ui.ledPower;

  renderer.setSize(canvas.clientWidth, canvas.clientHeight);
  camera.aspect = canvas.clientWidth/canvas.clientHeight;
  camera.updateProjectionMatrix();

  renderer.render(scene,camera);
}
requestAnimationFrame(animate);

// Controles UI
document.getElementById('channel').addEventListener('change',e=>{ui.channel=e.target.value;});
document.getElementById('ledPower').addEventListener('input',e=>{ui.ledPower=parseFloat(e.target.value);});
document.getElementById('freq').addEventListener('input',e=>{ui.freq=parseFloat(e.target.value);});
document.getElementById('pauseBtn').addEventListener('click',e=>{paused=!paused; e.target.textContent=paused?'‚ñ∂ Reanudar':'‚è∏ Pausar';});
</script>
</body>
</html>
